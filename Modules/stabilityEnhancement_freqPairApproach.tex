As demonstrated in the previous section, the beampattern \eqref{eq_generalH} is too sensitive to range errors.
We now propose an architecture which obtains the desired beampattern $\Hr_{\Delta\theta,\Delta\phi\to0,r}$ even for relatively large $\Delta R_{\text{rt}}$ values. Moreover, we intend to show that the suggested architecture even achieves high performance at moderately low signal to noise ratio (SNR) scenarios.

\subsection*{Intuitive explanation}
Bearing in mind that the system's phase alignment sensitivity resides in \eqref{eq_generalH} via the  term $\exp\Brack{j\dPhi}=\exp\Brack{j\omega\Delta\tau_{pd}}$ and that the round-trip delay ($\tau_{pd}$) cannot be controlled, one may suggest to use lower frequencies. 
Unfortunately, aiming for practical range estimation errors, the transmission of such low frequencies is physically unfeasible. 
Inspired by frequency sum and subtraction trigonometrical identities, we suggest simultaneous transmission of several frequency separated signals in order to resolve the range error sensitivity by virtually transmitting a low frequency signal.
\par In the following, we show a possible algorithm which achieves this goal by using a dual frequency (DF) waveform, transmitting two separated frequencies, $\omega_1$ and $\omega_2$.

\subsection*{Suggested processing scheme}
\begin{figure}[t!]
    \begin{center}
        \begin{overpic}[width=0.95\linewidth, 
        % grid, 
        tics=10,trim={0 0 0 0}]{./Media/SpatialIIR_APP.png}
            \put (12.5, 64){$\text{FB}_{\vAlphaI{1},\vBetaI{1}}$}
            \put (61, 64){$\text{FB}_{\vAlphaI{2},\vBetaI{2}}$}
            \put (4.5, 59){$z_{1}\rBrace{t}$}
            \put (54, 59){$z_{2}\rBrace{t}$}
            \put (12.9, 41.5){$\text{BPF}_{\omega_{1}}$}
            \put (61.65, 41.5){$\text{BPF}_{\omega_{2}}$}
            \put (6, 51.5){+}
            \put (55, 51.5){+}
            \put (16, 51.5){\footnotesize{$\text{n}_{1}\rBrace{t}$}}
            \put (64.75, 51.5){\footnotesize{$\text{n}_{2}\rBrace{t}$}}
            \put (24.5, 59){\footnotesize{$\Tx_{1}\rBrace{t}$}}
            \put (73.5, 59){\footnotesize{$\Tx_{2}\rBrace{t}$}}
            \put (36.25, 64){\scriptsize{$s_{1}\rBrace{t}$}}
            \put (43, 64){\scriptsize{$s_{2}\rBrace{t}$}}
            \put (18.25, 13){\footnotesize{Harmonic mean}}
            \put (32, 2){$z\rBrace{t}$}
            \put (54.75, 24){$\Sigma$}
            \put (21.75, 25){\footnotesize{$\mathcal{F}_{\omega_{1}}$}}
            \put (30.75, 25){\footnotesize{$\mathcal{F}_{\omega_{2}}$}}
        \end{overpic}
    \end{center}
    \caption{Dual-frequency beamformer, consisting of two independent FB blocks and narrowband bandpass filters. The blocks marked by $\mathcal{F}_{\omega_{i}}$ compute the Fourier coefficients in $\omega_{i}$ and their outputs feed the harmonic mean calculator which generates the DF beamformer's output.}
    \label{fig_app}
\end{figure}
In Fig.~\ref{fig_app}, we exemplify the use of two independently configured FB (see  Fig.~\ref{fig:Proposed_spatialIIR_ARCH}) instances, where each instance is designed to treat only a specific frequency. 
Two independent FB blocks and 4 band-pass-filters ($\text{BPF}_{\omega_{i}}$ filters a narrowband slice around $\omega_{i}$) are used to generate both the transmitted feedback signal ($\text{Tx}_{i}$) and the beamformers' outputs $z_{i}$. 
Also, $s_{i}(t) = e^{j\omega_{i}t}, \omega_{i} = 2\pi{f_{i}}$ where $i=1,2$ are two independent, narrowband, stimuli signals and $\text{n}_{i}$ are the additive noise instances. 
Note that we do not add array elements, but merely double the beamformer processing effort. 
\par For each single frequency FB block, the output \eqref{eqn:GeneralFeedbackTransferFunction} is
\[
z_{i}(t)=H_{\vAlphaI{i},\vBetaI{i}}\rBrace{\omega_{i}}\exp{\rBrace{j\omega_{i}t}}\ \ {i\in\cBrace{1,2}},
\]
where $\vAlphaI{i},\vBetaI{i}$ are the coefficients of the $i$'th beamformer. 
We then define the DF beamformer to be the harmonic mean of $H_{\vAlphaI{i},\vBetaI{i}}(\omega_i)$,
\begin{equation*}
    H_{\text{DF}} = \rBrace{H^{-1}_{\vAlphaI{1},\vBetaI{1}}\rBrace{\omega_{1}}+H^{-1}_{\vAlphaI{2},\vBetaI{2}}\rBrace{\omega_{2}}}^{-1}.
\end{equation*}
In practice, $H_{\text{DF}}$ may be estimated via the frequency domain evaluation of $z_1(t)$ and $z_2(t)$, as also illustrated in Fig.~\ref{fig_app}.
\ifdefined\useOmega
Straight forward derivations, Allowing $g$ to be frequency dependent, leads to
\else
Aiming for simplicity of the exposition, we use subscripts instead of formal $\omega$ dependency such that $\phiI{i}\triangleq\phi\rBrace{\omega_{i}}, \gI{i}\triangleq{}g\rBrace{\omega_{i}}, \vdI{i}\triangleq\vecnot{d}\rBrace{\omega_{i}}$ and express the DF beampattern as
\fi
\begin{equation*}
    \centering
    \ifdefined\useOmega
    \resizebox{1\linewidth}{!}{
    \fi
        \begin{split}
            \lBrace{H_{\text{DF}}}^{-1}
            =
            \Bigg{|}
            &\frac
            {
            \gI{2}\vBetaTI{2}\vdI{2}\exp{\rBrace{j\rBrace{\phiI{1}-\phiI{2}}}}+\gI{1}\vBetaTI{1}\vdI{1}
            }{
            \gI{1}\vBetaTI{1}\vdI{1}\gI{2}\vBetaTI{2}\vdI{2}
            }
            \\&-
            \frac
            {
            \rBrace{\vBetaTI{1}\vdI{1}\vAlphaTI{2}\vdI{2}+\vBetaTI{2}\vdI{2}\vAlphaT_{1}\vdI{1}}\exp{\rBrace{-j\phiI{2}}}
            }{
            \vBetaTI{1}\vdI{1}\vBetaTI{2}\vdI{2}
            }
            \Bigg{|},
        \end{split}
    \ifdefined\useOmega
    }
    \fi
\end{equation*}
\ifdefined\useOmega
% defining the $\omega_{i}$ related steering vector as
% \begin{equation}\label{eq:new_d}
% \vdI{i}=\sBrack{\exp{\rBrace{-j\omega_i\tau_{0}}},...,\exp{\rBrace{-j\omega_i\tau_{N-1}}}}^{T}
% \end{equation}
% where $\tau_{0}=0$.
\fi
Note that in the special case of choosing $\vAlphaI{1}~=~\vBetaI{1},\ \vAlphaI{2}~=~-~\vBetaI{2}$, the resultant beampattern simplifies to
\begin{equation}
    \label{eqn_twoFreqApproach_h}
    \abs{H_{\text{DF}}} = \lBrace{\frac{\gI{1}\vBetaTI{1}\vdI{1}}{1+\frac{\gI{1}\vBetaTI{1}\vdI{1}}{\gI{2}\vBetaTI{2}\vdI{2}}\exp{\rBrace{-j\rBrace{\phiI{1}-\phiI{2}}}}}}.
\end{equation}
Also, $\tau_n$ is arbitrary, hence the discussion is not restricted to a specific array geometry.
% and that the element-wise delay $\tau_n$ is arbitrary, hence we no longer restrict the discussion to linear arrays or any specific array manifold. 
% Also, as $\tau_n$ represents the inter-element delay, we use $\tau_0=0$ (i.e. treating sensor $0$ as the reference sensor).
We further simplify the second beamformer's weights to 
\begin{equation}\label{eq_simpleBeta}
    \vAlphaI{2}=-\vBetaI{2}=\vBrace{\gIHat{2},0,\hdots,0}.
\end{equation}
which when plugged in \eqref{eqn_twoFreqApproach_h} gives rise to 
\begin{equation}
    H_{\text{DF}} = \lBrace{\frac{\gI{1}\vBetaTI{1}\vdI{1}}{1+
    \rBrace{\gI{1}\vBetaTI{1}\vdI{1}/r_{2}}\exp\rBrace{-j\rBrace{\phiI{1}-\phiI{2}}}
    }},
    \label{eq_H_DF_general}
\end{equation}
denoting $r_i\triangleq{}\gI{i}/\gIHat{i}$ to be gain mismatch at $\omega_i$. 
\par The reader may notice that $H_{\text{DF}}$ closely resembles the single frequency (SF) beampattern \eqref{eqn:GeneralFeedbackTransferFunction}, where the range related phase $\phi$ is replaced by $\phiI{1}-\phiI{2}=(\omega_1-\omega_2)\tau_{pd}$. Hence, by using sufficiently close frequencies, one may significantly mitigate the range mismatch distortion of the beampattern.
\par For example, consider a radio frequency carrier of $10\text{GHz}$ and typical range error of $\Delta{}R_{\text{rt}}=10_{\text{m}}$, which is $333\frac{1}{3}\lambda$ (assuming light speed of $c=3\cdot 10^{8}_{\text{m/s}}$). The single frequency beampattern distortion, being periodic in $\lambda$, will closely resemble the $0.3\lambda$ error plot presented in Fig.~\ref{fig_rangError}. Assume that we aim at maximal phase error of $\Delta \phi=0.01\pi_{\text{RAD}}$. Hence, when using DF architecture, the dictated frequency relation is
\begin{equation}\label{eq_DF_phErr}
\abs{(\omega_1-\omega_2)\frac{\Delta{}R_{\text{rt}}}{c}}<0.01\pi.
\end{equation}
or equivalently, for maximal range error of $10_\text{m}$, frequency separation of
\[
\abs{f_1-f_2}<0.005 c/\Delta{}R_{\text{rt}}=150_{\text{KHz}}
\]
is required. 

\subsection*{Dual frequency simulation}
We now simulate \eqref{eq_H_DF_general} for the DF structured FB.
Using the $\coefSetName$ approach, we set $\vBetaI{1}$ as
\begin{equation*}
    \vBetaI{1}=-\vdHatIC{1}\exp\rBrace{j\rBrace{\phiIHat{1}-\phiIHat{2}}}/\hat{\gI{1}}\norm{\vdHatI{1}}^2.
\end{equation*}
% where $\vdHatI{1}$ is the estimated steering vector, as in \eqref{eq:d_hat}.
With this choice, and similarly to \eqref{eq:SF_CB}, \eqref{eq_H_DF_general} becomes
\begin{equation}
    \label{eqn_H_DF_CB}
    \resizebox{.89\linewidth}{!}{
        \begin{split}
            H_{\text{DF,\coefSetName}}\rBrace{\omega} =
            \lBrace{\frac{r_{1}\D{\dTheta/2}{N}}{1-
            \kappa\D{\dTheta/2}{N}\exp\rBrace{-j\rBrace{\phiI{2}-\phiI{1}+(N-1)\dTheta/2}}}
            },
        \end{split}
    }
\end{equation}
where $\kappa\triangleq{}r_{1}/r_{2}$ is the gain mismatch ratio.
For close frequencies, one may assume that $r_{1}\approx{}r_{2}$, hence $\kappa$ tends towards unity, thus significantly mitigating the gain mismatch effect even when both feedback beamformers are mismatched.
% \par In Fig.~\ref{fig_dualfreq_rangeErrorHighSnr}, we simulate the beampattern (normalized to $0$dB peak gain) for the single and DF architectures, where frequency separation was configured to mitigate the range errors according to \eqref{eq_DF_phErr} 
% (i.e. $f_1=10_{GHz},\;f_2=f_1+150_{KHz}$ to mitigate range errors up till $\Delta{}R_{\text{rt}}=10_m=333\frac{1}{3}\lambda$)
\par Simulating the DF architecture, configured to mitigate range estimation errors as in \eqref{eq_DF_phErr} and plotting its normalized (to $0$dB peak gain) beampattern together with the perfect align scenario's pattern (blue circles) in Fig.~\ref{fig_dualfreq_rangeErrorHighSnr}, we prove that the desired spatial beampattern is practically achieved.
In Fig.~\ref{fig_dualfreq_perfectAlignLowSnr}, we simulate range error of $\Delta{}R_{\text{rt}}=0.3\lambda$, while adding white Gaussian noise to the output of each feedback beamformer. Evidently, the DF beamformer (green diamonds) achieves close-to-ideal beampattern (blue circles), while the SF beamformer (red squares) suffers severe distortions.
% We repeat the case of fractional range error of $\Delta{}R_{\text{rt}}=0.3\lambda$, while adding white Gaussian noise to the output of each feedback beamformer. Evidently, the dual-frequency beamformer (green diamonds) achieves close-to-ideal beampattern (blue circles), while the single-frequency beamformer (red squares) suffers severe distortions.
\begin{figure}[t!]
    \begin{center}
        \begin{overpic}[width=.7\linewidth, 
        % grid, 
        tics=10,trim=0 0 0 0]{./Media/fig_dualfreq_rangeErrorHighSnr.eps}
            \put (48, 43){\scriptsize{Ideal}}
            \put (48, 37.5){\scriptsize{SF}}
            \put (48, 32){\scriptsize{DF}}
            \put (2, 37.5){\footnotesize{dB}}
            \put (47,0){\footnotesize{$\dTheta/\pi$}}
            \put (92,58){\footnotesize{$\Delta{}R_{\text{rt}}=0.3\lambda$}}
        \end{overpic}
    \end{center}
    \caption{Simulating 3 element ULA with $r_1=0.6^{2},\; r_2=0.6$ (hence $\kappa=0.6$) for infinite SNR. The (fractional) range error is $\Delta{}R_{\text{rt}}=0.3\lambda$.
    The ideal response is obtained for $\Delta{}R_{\text{rt}}=0$ (blue dots), with the single frequency (SF) beamformer (red squares) and the  dual-frequency (DF) solution (green diamonds). 
    }
    \label{fig_dualfreq_rangeErrorHighSnr}
\end{figure}
\begin{figure}[t!]
    \begin{center}
        \begin{overpic}[width=0.9\linewidth, 
        % grid, 
        tics=10,
        % trim={<left> <lower> <right> <upper>}
        trim={1.75cm 0 1.75cm 0}
        ]{./Media/fig_dualfreq_rangeErrorLowSnr.eps}
            \put (42.25, 17.5){\scriptsize{Ideal}}
            \put (42.25, 14.5){\scriptsize{SF}}
            \put (42.25, 11.5){\scriptsize{DF}}
            \put (-1, 26.5){\footnotesize{dB}}
            \put (22, 0){\footnotesize{$\dTheta/\pi$}}
            \put (19,17){\scriptsize{$\text{SNR}=6_{dB}$}}
            \put (71.5,17){\scriptsize{$\text{SNR}=0_{dB}$}}
        \end{overpic}
    \end{center}
    \caption{Directional response of the 3 element ULA, as in Fig.~\ref{fig_dualfreq_rangeErrorHighSnr}, simulated for the noisy scenario. The additive noises $\text{n}_1(t)$ and $\text{n}_2(t)$ (see Fig.~\ref{fig_app}), are set to obtain SNR of $6_{dB}$ (left plot) and $0_{dB}$ (right plot).}
    \label{fig_dualfreq_perfectAlignLowSnr}
\end{figure}