As demonstrated in the previous section, the beampattern \eqref{eq_generalH} is very sensitive to range errors.
We now propose an architecture which obtains the desired beampattern $\Hr_{\dTheta,\dPhi=0,r}$ even when in practice, the true range to the target is unknown (i.e. $\Delta R_{rt}$ is large). Moreover, we intend to show that the suggested architecture operates at moderately low signal to noise ratio (SNR).

\subsection*{Motivation}
Bearing in mind that the system's phase alignment sensitivity resides in \eqref{eq_generalH} via the  term $\exp\Brack{j\dPhi}=\exp\Brack{j\omega\Delta\tau_{pd}}$, and that the round-trip delay (i.e. $\tau_{pd}$) cannot be controlled, one may suggest to use lower frequencies. Unfortunately, in most cases, this is irrelevant, being physically unfeasible to transmit at very low frequency. Another approach is to simultaneously use several frequencies in order to resolve the range error sensitivity. In the following, we show a possible algorithm which achieves this goal by transmitting with two frequencies $\omega_1$ and $\omega_2$.

\subsection*{Suggested processing scheme}
\begin{figure}[t!]
    \begin{center}
        \begin{overpic}[width=0.95\linewidth, 
        % grid, 
        tics=10,trim={0 0 0 0}]{./Media/SpatialIIR_APP.png}
            \put (12.5, 64){$\text{FB}_{\vAlpha_{1},\vBeta_{1}}$}
            \put (61, 64){$\text{FB}_{\vAlpha_{2},\vBeta_{2}}$}
            \put (4.5, 59){$y_{1}\rBrace{t}$}
            \put (54, 59){$y_{2}\rBrace{t}$}
            \put (12.9, 41.5){$\text{BPF}_{\omega_{1}}$}
            \put (61.65, 41.5){$\text{BPF}_{\omega_{2}}$}
            \put (6, 51.5){+}
            \put (55, 51.5){+}
            \put (16, 51.5){\footnotesize{$n_{1}\rBrace{t}$}}
            \put (64.75, 51.5){\footnotesize{$n_{2}\rBrace{t}$}}
            \put (24.5, 59){\footnotesize{$\text{Tx}_{1}\rBrace{t}$}}
            \put (73.5, 59){\footnotesize{$\text{Tx}_{2}\rBrace{t}$}}
            \put (36.25, 64){\scriptsize{$x_{1}\rBrace{t}$}}
            \put (43, 64){\scriptsize{$x_{2}\rBrace{t}$}}
            \put (18.25, 13){\footnotesize{Harmonic mean}}
            \put (32, 2){$y\rBrace{t}$}
            \put (54.75, 24){$\Sigma$}
            \put (21.75, 25){\footnotesize{$\mathcal{F}_{\omega_{1}}$}}
            \put (30.75, 25){\footnotesize{$\mathcal{F}_{\omega_{2}}$}}
        \end{overpic}
    \end{center}
    \caption{Dual-frequency beamformer, consisting of two independent FB blocks and nerrwoband bandpass filters. The blocks marked by $\mathcal{F}_{\omega_{i}}$ compute the Fourier coefficients in $\omega_{i}$ and their outputs feed the harmonic mean calculator which generates the DF beamformer's output.}
    \label{fig_app}
\end{figure}
In Fig.~\ref{fig_app}, we exemplify the use of two independently configured instances of the feedback beamformer (of Fig.~\ref{fig:Proposed_spatialIIR_ARCH}), where each instance is designed to treat only a specific frequency. 
\par For this, two independent FB blocks and 4 nerrow-band band-pass-filters ($\text{BPF}_{\omega_{i}}$ filters a nerrow band slice around $\omega_{i}$) are used to generate both the transmitted feedback signal ($\text{Tx}_{i}$) and the beamformers' outputs $y_{i}$. 
\par Also, $x_{i}(t) = e^{j\omega_{i}t}, \omega_{i} = 2\pi{f_{i}}$ with $i=1,2$ are two independent, narrow band, stimuli signals and $n_{i}$ are additive noise instances. 
\par Note that we do not increase the number of array elements, but merely double the beamformer processing part. 
\par For each single frequency FB block \eqref{eqn:GeneralFeedbackTransferFunction} the output is
\[
y_{i}(t)=H_{\vAlpha_{i},\vBeta_{i}}\rBrace{\omega_{i}}\exp{\rBrace{j\omega_{i}t}}\ \ {i\in\cBrace{1,2}},
\]
where $\vAlpha_{i},\vBeta_{i}$ are the coefficients of the $i$'th beamformer. 
\par We define $H_{\text{DF}}$ to be the \textit{dual frequency} beamformer, which is computed as the harmonic mean of $H_{\vAlpha_{i},\vBeta_{i}}(\omega_i)$ 
\begin{equation*}
    H_{\text{DF}} = \rBrace{H^{-1}_{\vAlpha_{1},\vBeta_{1}}\rBrace{\omega_{1}}+H^{-1}_{\vAlpha_{2},\vBeta_{2}}\rBrace{\omega_{2}}}^{-1}.
\end{equation*}
In practice, $H_{\text{DF}}$ can be estimated by evaluating $y_1(t)$ and $y_2(t)$ in the frequency domain, as also illustrated in Fig.~\ref{fig_app}.

By straight forward derivations, one may deduce that $\lBrace{H_{\text{DF}}}^{-1}$ is
% \begin{equation*}
%     \resizebox{1\linewidth}{!}{
%         \begin{split}
%             \lBrace{H_{\text{DF}}} =
%             \lBrace{
%             \frac
%             {
%             \vBetaT_{1}\vd_{1}\vBetaT_{2}\vd_{2}
%             }{
%             \vBetaT_{2}\vd_{2}\exp{\rBrace{-j\rBrace{\phi_{1}-\phi_{2}}}}+\vBetaT_{1}\vd_{1}
%             -\rBrace{\vBetaT_{1}\vd_{1}\vAlphaT_{2}\vd_{2}+\vBetaT_{2}\vd_{2}\vAlphaT_{1}\vd_{1}}\exp{\rBrace{-j\phi_{2}}}
%             }
%             }.
%         \end{split}
%     }
% \end{equation*}
\begin{equation*}
    \resizebox{1\linewidth}{!}{
        \begin{split}
            \lBrace{
            \frac
            {
            \vBetaT_{2}\vd_{2}\exp{\rBrace{j\rBrace{\phi_{1}-\phi_{2}}}}+\vBetaT_{1}\vd_{1}
            }{
            \vBetaT_{1}\vd_{1}\vBetaT_{2}\vd_{2}
            }
            -
            \frac
            {
            \rBrace{\vBetaT_{1}\vd_{1}\vAlphaT_{2}\vd_{2}+\vBetaT_{2}\vd_{2}\vAlphaT_{1}\vd_{1}}\exp{\rBrace{-j\phi_{2}}}
            }{
            \vBetaT_{1}\vd_{1}\vBetaT_{2}\vd_{2}
            }
            }.
        \end{split}
    }
\end{equation*}
Note that in the special case  where we choose $\vAlpha_{1}~=~\vBeta_{1},\ \vAlpha_{2}~=~-~\vBeta_2{}$, the resultant beampattern is simplified to
\begin{equation}
    \label{eqn_twoFreqApproach_h}
    \abs{H_{\text{DF}}} = \lBrace{\frac{\vBetaT_{1}\vd_{1}}{1+\frac{\vBetaT_{1}\vd_{1}}{\vBetaT_{2}\vd_{2}}\exp{\rBrace{-j\rBrace{\phi_{1}-\phi_{2}}}}}}.
\end{equation}
\par In the general case, the gain of each element is frequency dependant, such that the steering vector $\vd$ of \eqref{eq:d}
can be written as 
\begin{equation*}
    \vd_{\theta_g}[n] = g_{n,\theta_{g}}(\omega)\exp{\rBrace{-j\omega\tau_{n,\theta_g}}},\;n=0,\ldots,N-1.
\end{equation*}
To simplify the exposition, assume that the gain of all the elements is the same, such that $g_{\theta_{g}}(\omega)$ is not a function of the element index $n$. Suppressing also the dependence on the DOA $\theta_g$ (which is the same at both frequencies), the  steering vector at the $i$'th frequency is of the form
\begin{equation}\label{eq:new_d}
\vd_{i}^T=g(\omega_i)\sBrack{\exp{\rBrace{-j\omega_i\tau_{0}}},...,\exp{\rBrace{-j\omega_i\tau_{N-1}}}}.
\end{equation}
Note that the element-wise delay $\tau_n$ is arbitrary, hence we no longer restrict the discussion to linear arrays or any specific array manifold. Also, as $\tau_n$ represents the inter-element delay, we use $\tau_0=0$. 

We further simplify the second beamformer weights to 

% The gain mismatch at each frequency is now
% \[
% r_i= g(\omega_i)/\hat{g}(\omega_i)
% \]
% and we define 
% \begin{equation}
%     \label{eqn_kappa_def}
%     \kappa\triangleq{}r_{1}/r_{2}
% \end{equation}
% to be the gain mismatch ratio, at the two frequencies.

% \par Following \eqref{eq:new_d},
% $$
% \vd_{2}\vBrace{n} =  \rBrace{g(\omega_2)/g(\omega_1)}\vd_{1}\vBrace{n}\exp\rBrace{{-j\rBrace{\phi_{2}-\phi_{1}}}},
% $$
% where $\vd_{i}$ is the steering vector of the impinging signal in $\omega_{i}$.

\begin{equation}\label{eq_simpleBeta}
    \vAlpha_{2}=-\vBeta_{2}=\vBrace{\hat{g}^{-1}(\omega_2),0,\hdots,0}.
\end{equation}
Using \eqref{eq_simpleBeta} within  \eqref{eqn_twoFreqApproach_h} gives rise to 
\begin{equation}
    H_{\text{DF}} = \lBrace{\frac{\vBetaT_{1}\vd_{1}}{1+
    \rBrace{\vBetaT_{1}\vd_{1}/r_{2}}\exp\rBrace{-j\rBrace{\phi_{1}-\phi_{2}}}
    }},
    \label{eq_H_DF_general}
\end{equation}
where $r_i=g(\omega_i)/\hat{g}(\omega_i)$ is the gain mismatch at $\omega_i$. \par Notice that  $H_{\text{DF}}$ is similar to the single frequency (SF) beampattern \eqref{eqn:GeneralFeedbackTransferFunction}, where now the range related phase $\phi$ is replaced by $\phi_{1}-\phi_{2}=(\omega_1-\omega_2)\tau_{pd}$. Hence, by using sufficiently close frequencies, range mismatches can be controlled and significantly mitigated.
\par For example, consider a radio frequency carrier of $10\text{GHz}$ and typical range error of $\Delta{}R_{rt}=10_m$, which is $333\frac{1}{3}\lambda$ (assuming light speed of $c=3\cdot 10^{8}_{m/s}$). The single frequency beampattern distortion, being periodic in $\lambda$, will be distorted as for $\Delta{}R_{rt}=\lambda/3$, which is similar to the $0.3\lambda$ error plot presented in Fig.~\ref{fig_rangError}. 
\par Assume that we aim at maximal phase error of $\Delta \phi=0.01\pi_{rad}$. For the dual frequency beamformer, this can be achieved by requiring
\begin{equation}\label{eq_DF_phErr}
\abs{(\omega_1-\omega_2)\frac{\Delta{}R_{rt}}{c}}<0.01\pi,
\end{equation}
or equivalently, for maximal range error of $10_m$, one needs to use two frequencies with separation of
\[
\abs{f_1-f_2}<0.005 c/\Delta{}R_{rt}=150_{KHz}. 
\]

\subsection*{Dual frequency $\coefSetName$ simulation}
We now simulate \eqref{eq_H_DF_general} for the $\coefSetName$ approach assuming ULA. Using coefficients $\vBeta_{1}$ which will coherently sum the wave-front, while minimizing the magnitude of the denominator, we use
\begin{equation*}
    \vBeta_{1}=-\hat{\vd}^{\ast}\exp\rBrace{j\rBrace{\hat{\phi}_{1}-\hat{\phi}_{2}}}/\norm{\hat{\vd}}^2
\end{equation*}
where $\hat{\vd}$ is the estimated steering vector, as in \eqref{eq:d_hat}. With this choice, and similarly to \eqref{eq:SF_CB}, \eqref{eq_H_DF_general} becomes
\begin{equation}
    \label{eqn_H_DF_CB}
    \resizebox{.89\linewidth}{!}{
        \begin{split}
            H_{\text{DF,CB}} =
            \lBrace{\frac{r_{1}\D{\dTheta/2}{N}}{1-
            \kappa\D{\dTheta/2}{N}\exp\rBrace{-j\rBrace{\dPhi_{2}-\dPhi_{1}+(N-1)\dTheta/2}}}
            },
        \end{split}
    }
\end{equation}
where $\kappa\triangleq{}r_{1}/r_{2}$ is the gain mismatch ratio. Note that if the array elements have similar gain at $\omega_1$ and $\omega_2$ we also mitigate the gain mismatch, as $\kappa$ will be close to one.
\par In Fig.~\ref{fig_dualfreq_rangeErrorHighSnr}, we simulate the beampattern (normalized to $0$dB peak gain) for the single and dual frequency case, where frequency separation was configured to obtain range errors as in \eqref{eq_DF_phErr} (i.e. $f_1=10_{GHz},\;f_2=f_1+150_{KHz}$ to mitigate range errors up till $\Delta{}R_{rt}=10_m=333\frac{1}{3}\lambda$). 
\par We also plot (in blue circles) the perfectly aligned pattern, which is obtained when there are no range errors. 
\par As can be seen, the resultant beampattern of the dual frequency beamformer practically achieves the ideal, range-error free case. 

In Fig.~\ref{fig_dualfreq_perfectAlignLowSnr}
we repeat the case of fractional range error of $\Delta{}R_{rt}=0.3\lambda$, while adding white Gaussian noise to the output of each feedback beamformer. Evidently, the dual-frequency beamformer (green diamonds) achieves close-to-ideal beampattern (blue circles), while the single-frequency approach (red squares) suffers severe distortions.
% \begin{figure}[t!]
%     \begin{center}
%         \begin{overpic}[width=.9\linewidth, 
%         % grid, 
%         tics=10,trim=0 0 0 0]{./Media/fig_dualfreq_perfectAlignHighSnr.png}
%             \put (38, 43.85){\scriptsize{theory BP}}
%             \put (38, 40.85){\scriptsize{SF}}
%             \put (38, 38){\scriptsize{DF}}
%             \put (-5, 25){\footnotesize{dB}}
%             \put (-6, 48) {\footnotesize{$10\log_{10}\abs{\Hr_{\dTheta,\dPhi=0,r=0.6}}^2$}}
%             \put (21, -3){\footnotesize{$\dTheta/\pi$}}
%         \end{overpic}
%     \end{center}
%     \caption{We simulate 3 sensor array with $r=\kappa=0.6$ under the perfect alignment scenario, and show that both the SF and DF beampatterns accurately follow the theoretical result. We also demonstrate the beam steering ability, such that the left plot is for $\theta_{g,s}=\pi/2$ and the right is for $\theta_{g,s}=3\pi/4$.}
%     \label{fig_dualfreq_perfectAlignHighSnr}
% \end{figure}
\begin{figure}[t!]
    \begin{center}
        \begin{overpic}[width=.7\linewidth, 
        % grid, 
        tics=10,trim=0 0 0 0]{./Media/fig_dualfreq_rangeErrorHighSnr.eps}
            \put (48, 43){\scriptsize{Ideal}}
            \put (48, 37.5){\scriptsize{SF}}
            \put (48, 32){\scriptsize{DF}}
            \put (2, 37.5){\footnotesize{dB}}
            \put (47,0){\footnotesize{$\dTheta/\pi$}}
            \put (92,58){\footnotesize{$\Delta{}R_{rt}=0.3\lambda$}}
        \end{overpic}
    \end{center}
    \caption{Simulating 3 element ULA with $r_1=0.6^{2},\; r_2=0.6$ (hence $\kappa=0.6$) for infinite SNR. The (fractional) range error is $\Delta{}R_{rt}=0.3\lambda$.
    The ideal response is obtained for $\Delta{}R_{rt}=0$ (blue dots), with the single frequency (SF) beamformer (red squares) and the  dual-frequency (DF) solution (green diamonds). 
    }
    \label{fig_dualfreq_rangeErrorHighSnr}
\end{figure}
\begin{figure}[t!]
    \begin{center}
        \begin{overpic}[width=0.9\linewidth, 
        % grid, 
        tics=10,
        % trim={<left> <lower> <right> <upper>}
        trim={1.75cm 0 1.75cm 0}
        ]{./Media/fig_dualfreq_rangeErrorLowSnr.eps}
            \put (42.25, 17.5){\scriptsize{Ideal}}
            \put (42.25, 14.5){\scriptsize{SF}}
            \put (42.25, 11.5){\scriptsize{DF}}
            \put (-1, 26.5){\footnotesize{dB}}
            \put (22, 0){\footnotesize{$\dTheta/\pi$}}
            \put (19,17){\scriptsize{$\text{SNR}=6_{dB}$}}
            \put (71.5,17){\scriptsize{$\text{SNR}=0_{dB}$}}
        \end{overpic}
    \end{center}
    \caption{Directional response of the 3 element ULA, as in Fig.~\ref{fig_dualfreq_rangeErrorHighSnr}, simulated for the noisy scenario. The additive noises $n_1(t)$ and $n_2(t)$ (see Fig.~\ref{fig_app}), are set to obtain SNR of $6_{dB}$ (left plot) and $0_{dB}$ (right plot).}
    \label{fig_dualfreq_perfectAlignLowSnr}
\end{figure}